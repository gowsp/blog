title: Jvm串行回收器以及并行回收器
date: 2021-01-24
tags:
- Jvm
---
上篇讲述了jvm回收器所使用的分代回收技术和对象分配的逻辑，那么按着内存管理白皮书的顺序本文将介绍jvm几种垃圾回收器工作的过程。
<!--more-->

## 串行收集器

串行收集器可以在命令行使用`-XX:+UseSerialGC`启用，其以`stop-the-world`的方式连续（使用单个CPU）对年轻代和终身代进行收集。 这里需要介绍下`stop-the-world`世界停止，表示垃圾回收器工作时，整个应用程序的执行将会停止，等待回收工作完成后才会继续运行。

### 年轻代回收

我们知道年轻代由一个伊甸区和两个幸存者区组成，关于年轻代的回收就涉及这部分和终身代区。下图即揭示了回收过程

![][01]

其中已满的伊甸区和一个的幸存者区“From”是回收对象存在的范围，另外完全空的一个幸存者区“To”和终身代是存活对象将要被复制的去处。伊甸区中存活的对象将会被复制到“To”，而“From”在复制前先判断对象是否达足够老，是则将被复制到终身代，否则被复制到“To”。在复制到“To”时有如下条件时将会直接复制到终身代中

- 对象体积过大不适合放在“To”
- “To”区域已装满，此时任何存活对象无论幸存次数是否达到晋升标准都将被直接复制到终身代中

在所有存活对象被复制之后，剩下的就是垃圾对象（在图里用红X标注），之后伊甸区和“From”将被清空，年轻代中只有幸存者区“To”还保留则存活对象，之后幸存者区From”和“To”将会交换角色。

![][02]

### 终身代回收

串行回收器使用`mark-sweep-compact`回收算法

- `mark`标记，标记出仍然存活的对象
- `sweep`清理，清理堆上垃圾对象
- `compact`压紧，回收器使用一种名为`sliding compaction`滑动压缩技术，将存活对象滑动到终身代开始的地方，留下一块儿连续可用的空间

压紧之后的内存空间可以让以后终身代分配对象时可以使用快速触碰指针的技术。

![][03]

## 并行回收器

并行回收器可以使用`-XX:+UseParallelGC`启用。如今的机器拥有大内存和多个CPU，串行回收器显然无法充分利用机器的性能，并行收集器（也称为吞吐量收集器）的开发就是为了充分利用CPU，而不是单个CPU进行垃圾收集工作，其它CPU围观。

### 年轻代回收

![][04]

并行回收器在年轻代上使用的算法和串行回收器没有区别，同样会出现`stop-the-world`，但由于并行执行所以应用暂停时间变短，因此吞吐量比串行回收器要好。

### 终身代回收

终身代的回收与串行回收器一样，也是使用了`mark-sweep-compact`，由单个CPU执行。

### 并行压缩回收器

并行压缩回收器在终身代上使用了与并行回收器不同的回收算法，最后后会代替并行回收器。

### 年轻代回收

并行压缩回收器在年轻代的回收与并行回收器一样，换言之也是串行回收器垃圾回收的并行版本。

### 终身代回收

将终身代在逻辑上划分为若干块固定大小的子区域，以`stop-the-world`方式并行的滑动压缩，其主要分为三个阶段`mark-summary-compact`

- 标记阶段，存活的对象集被划分给垃圾回收线程，然后并行标记处理所有存活对象。当对象被标识为存活对象时，该对象的大小和位置的信息更新到其所在的区域数据。
- 摘要阶段对区域而非对象进行操作。由于先前的回收压缩，区域左侧通常比较密集，包含大部分存活对象。在密集区域中回收的空间较少，对应的压缩的成本过高。因此，摘要阶段要做的第一件事是检查区域密度，从最左侧开始，找到一个临界点，该点区域和右侧区域值得被压缩。该点左侧区域称为密集前缀，密集前缀中没有对象压缩操作。该点右边的区域将被压缩，回收消亡对象的内存空间。接着摘要阶段会为每个压缩区域计算首个存储存活对象的地址。摘要阶段目前为串行执行，后续可能会并行化，但不如标记和压缩的并行化重要。
- 在压缩阶段，垃圾回收线程使用之前的摘要数据来标识需要填充的区域，多线程独立地将数据复制到区域中。最终形成左边密集右边空闲的堆。


## 写在最后

以上便是Jvm里的几种垃圾回收器，可以帮助我们理解垃圾回收的工作过程，尤其是串行回收器，虽然现在不常用，但是其对年轻代的回收的机制是其他垃圾回收器也在使用的。这些介绍大多是一些粗浅的翻译版本，但还是希望能帮到各位。


[01]:https://preview.cloud.189.cn/image/imageAction?param=7C785FA0178B6B9ABF847C618C102672ACE24FE9F71D61DA5AB494035C773EC47D0E01D07F2D73231438CDECC1B34466A6E907509514741E1E07E330C1630BCFAD4BD4567DE8836C0D4F67A95D50B4F4301B19EF4CCDF663676F8DC5
[02]:https://preview.cloud.189.cn/image/imageAction?param=440FA3E470DB36B2F5795F640D7A26BC85FB3EFE16C09CA1ED0061322D00C7352D3537257D1C05F12F414B2C605329136EF2DFC7EF85C36BA1C4BD051540CF8CB2EDD2BCAE60DC71BF12F47D67883C32D81B026F7C1440AD630A00AA
[03]:https://preview.cloud.189.cn/image/imageAction?param=8A8C32C605C85D9FB9E44327A7D438F89083B317589A6E1D40AB223F4B134D7053D2F0A0E0556D4457C7784CE59ABDE23C40830F11596C9827EBD9B6AEE8DD6947C9518F0B3803DF9556856EACAB2C9287D32B32F27A1F0AA291F778
[04]:https://preview.cloud.189.cn/image/imageAction?param=DCCC223AA4DB60671819EE5AE9F7A0565CC422B735C22CA491D8037DF86500A0D3675F50448BC0756CA3A6316208B4E1C592AABC4D86CDFA92DF2BC9AB30588CC41384D080AE904172118072C99C808AD404FD28FDC0E8771C2CA350
